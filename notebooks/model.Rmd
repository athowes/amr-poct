---
title: "Cost effectiveness analysis for an AMR point-of-care test"
author: "Adam Howes"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(purrr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(pals)
```

## Background

* Neonate with suspected neonatal sepsis in India
* Considered two possible point-of-care tests (POCT)
  a. POCT to identify neonatal sepsis, but not causative pathogen **modelled in Scenario 2**
  b. POCT to identify neonatal sepsis and causative pathogen **not yet modelled**
* Metrics are cost per disability adjusted life year (DALY) and [incremental cost-effectiveness ratio](https://en.wikipedia.org/wiki/Incremental_cost-effectiveness_ratio) (ICER)

```{r}
#' Number of children born in India each year
births_per_year <- 25 * 10^6

#' Rate of having neonatal sepsis
sepsis_rate <- 70 / 1000

#' The number of births with neonatal sepsis is
(births_sepsis <- births_per_year * sepsis_rate)

#' Of those, assume 40% are high risk and 60% are low risk
#' High risk means easy to spot (obvious symptoms)
#' Low risk means harder to spot (no obvious symptoms)
#' 40% is probably a high estimate of the proportion which are high risk
prop_high_risk_sepsis <- 0.4
prop_low_risk_sepsis <- 1 - prop_high_risk_sepsis

#' Total births with high risk sepsis
#' Assume that all high risk cases recieve correct treatment
(births_sepsis_high_risk <- births_sepsis * prop_high_risk_sepsis)

#' Total births with low risk sepsis
(births_sepsis_low_risk <- births_sepsis * prop_low_risk_sepsis)

#' Assume 20% of neonates receive antibiotics
prop_abx <- 0.2

#' Then the total number of births who receive anitbiotics per year is
(births_abx <- births_per_year * prop_abx)

#' Assume that all high risk births receive antibiotics
(births_abx_sepsis_high_risk <- births_sepsis_high_risk)

#' Assume the remainder are given to those who are low risk
(births_abx_sepsis_low_risk <- births_abx - births_abx_sepsis_high_risk)
```

```{r}
#' AMR burden per prescription of antibiotics
total_births_per_year <- 130 * 10^6
(total_births_abx_per_year <- total_births_per_year * prop_abx)
total_sepsis_burden <- 24.6 * 10^6
prop_burden_abx <- 0.31
total_amr_burden <- total_sepsis_burden * prop_burden_abx
(amr_burden_per_abx <- total_amr_burden / total_births_abx_per_year)
```

```{r}
cost_culture <- 50
total_cost_rdt <- 20
subsidy_rdt <- 10
(cost_rdt <- total_cost_rdt - subsidy_rdt)
cost_treatment <- 5
```

## Scenario 1

```{r}
#' Number of DALYs averted by correctly treating
benefit_correct_sepsis_diagnosis <- 9

#' Treat every neonate with low risk
(benefit_empiric <- benefit_correct_sepsis_diagnosis * births_sepsis_low_risk - amr_burden_per_abx * (births_abx_sepsis_low_risk - births_sepsis_low_risk))

#' Total cost to culture and treat all
cost_empiric <- (cost_culture + cost_treatment) * births_abx_sepsis_low_risk

#' Cost per DALY
(cost_per_daly_s1 <- cost_empiric / benefit_empiric)
```

## Scenario 2

The sensitivity is defined as

$$
\text{sensitivity} = \frac{\text{TP}}{\text{TP} + \text{FN}},
$$
and the specificity is defined as

$$
\text{specificity} = \frac{\text{TN}}{\text{TN} + \text{FP}}.
$$

```{r}
sensitivity <- 0.9
specificity <- 0.9

sepsis_prev_low_risk <- births_sepsis_low_risk / births_abx_sepsis_low_risk

#' Has sepsis and treated
(true_positive <- births_abx_sepsis_low_risk * sepsis_prev_low_risk * sensitivity)
  
#' Doesn't have sepsis and treated
(false_positive <- births_abx_sepsis_low_risk * (1 - sepsis_prev_low_risk) * (1 - specificity))
  
#' Has sepsis and not treated
(false_negative <- births_abx_sepsis_low_risk * sepsis_prev_low_risk * (1 - sensitivity))
  
#' Doesn't have sepsis and not treated
(true_negative <- births_abx_sepsis_low_risk * (1 - sepsis_prev_low_risk) * specificity)

stopifnot(true_positive + false_positive + false_negative + true_negative == births_abx_sepsis_low_risk)

#' Estimate that around half of false negatives would later be identified
harm_false_negative <- benefit_correct_sepsis_diagnosis * 0.5

(benefit_test <- true_positive * benefit_correct_sepsis_diagnosis + true_negative * amr_burden_per_abx - harm_false_negative * false_negative - amr_burden_per_abx * false_positive)
(cost_test <- (cost_culture + total_cost_rdt) * births_abx_sepsis_low_risk + (true_positive + false_positive) * cost_treatment)

#' Cost per DALY
(cost_per_daly_s2 <- cost_test / benefit_test)
```

## Cost effectiveness

* Relevant outcomes
  1. Cost effectiveness of POCT (no subsidy)
  2. Cost effectiveness of POCT (subsidised)
    a) ICER compared to baseline scenario
    b) Cost effectiveness of prize for funders
* Vary `sensitivity` and `specificty` for 1. and 2.
* Vary `subsidy_rdt` for 2.

```{r}
#' Total amount of subsidy in scenario 2
(subsidy_test <- subsidy_rdt * births_abx_sepsis_low_risk)

#' Additional cost of scenario 2 over scenario 1 for government
(cost_incremental <- cost_test - subsidy_test - cost_empiric)

#' Additional benefit of scenario 2 over scenario 1
(benefit_incremental <- benefit_test - benefit_empiric)

#' ICER
(icer <- cost_incremental / benefit_incremental)
```

## Sensitivity analysis

```{r}
run_cea <- function(sensitivity, specificity) {
  births_per_year <- 25 * 10^6
  sepsis_rate <- 70 / 1000
  births_sepsis <- births_per_year * sepsis_rate
  prop_high_risk_sepsis <- 0.4
  prop_low_risk_sepsis <- 1 - prop_high_risk_sepsis
  births_sepsis_high_risk <- births_sepsis * prop_high_risk_sepsis
  prop_abx <- 0.2
  births_abx <- births_per_year * prop_abx
  births_abx_sepsis_high_risk <- births_sepsis_high_risk
  births_abx_sepsis_low_risk <- births_abx - births_abx_sepsis_high_risk
  
  total_births_per_year <- 130 * 10^6
  total_births_abx_per_year <- total_births_per_year * prop_abx
  
  total_sepsis_burden <- 24.6 * 10^6
  prop_burden_abx <- 0.31
  total_amr_burden <- total_sepsis_burden * prop_burden_abx
  amr_burden_per_abx <- total_amr_burden / total_births_abx_per_year
  
  cost_culture <- 50
  total_cost_rdt <- 20
  subsidy_rdt <- 10
  cost_rdt <- total_cost_rdt - subsidy_rdt
  cost_treatment <- 5
  
  # Scenario 1
  benefit_correct_sepsis_diagnosis <- 9
  benefit_empiric <- benefit_correct_sepsis_diagnosis * births_sepsis_low_risk - amr_burden_per_abx * (births_abx_sepsis_low_risk - births_sepsis_low_risk)
  cost_empiric <- (cost_culture + cost_treatment) * births_abx_sepsis_low_risk
  cost_per_daly_s1 <- cost_empiric / benefit_empiric
  
  # Scenario 2
  sepsis_prev_low_risk <- births_sepsis_low_risk / births_abx_sepsis_low_risk
  true_positive <- births_abx_sepsis_low_risk * sepsis_prev_low_risk * sensitivity
  false_positive <- births_abx_sepsis_low_risk * (1 - sepsis_prev_low_risk) * (1 - specificity)
  false_negative <- births_abx_sepsis_low_risk * sepsis_prev_low_risk * (1 - sensitivity)
  true_negative <- births_abx_sepsis_low_risk * (1 - sepsis_prev_low_risk) * specificity
  stopifnot(true_positive + false_positive + false_negative + true_negative == births_abx_sepsis_low_risk)
  harm_false_negative <- benefit_correct_sepsis_diagnosis * 0.5
  benefit_test <- true_positive * benefit_correct_sepsis_diagnosis + true_negative * amr_burden_per_abx - harm_false_negative * false_negative - amr_burden_per_abx * false_positive
  cost_test <- (cost_culture + total_cost_rdt) * births_abx_sepsis_low_risk + (true_positive + false_positive) * cost_treatment
  cost_per_daly_s2 <- cost_test / benefit_test
  
  subsidy_test <- subsidy_rdt * births_abx_sepsis_low_risk
  cost_incremental <- cost_test - subsidy_test - cost_empiric
  benefit_incremental <- benefit_test - benefit_empiric
  icer <- cost_incremental / benefit_incremental
  return(list(icer = icer, cost_incremental = cost_incremental, benefit_incremental = benefit_incremental))
}
  
run_cea(0.9, 0.9)
```

```{r}
grid <- seq(from = 0, to = 1, length.out = 41)

df <- tidyr::crossing(sensitivity = grid, specificity = grid)
df <- bind_cols(df, pmap_dfr(df, run_cea))

ggplot(df, aes(x = sensitivity, y = specificity, fill = icer)) + 
  geom_tile() +
  coord_fixed(ratio = 1) +
  theme_minimal() +
  labs(x = "Sensitivity", y = "Specificity", fill = "ICER") +
    scale_fill_gradient2(low = munsell::mnsl("10R 6/10"), high = munsell::mnsl("10PB 6/10"), mid = "white")

ggplot(df, aes(x = sensitivity, y = specificity, fill = cost_incremental)) + 
  geom_tile() +
  coord_fixed(ratio = 1) +
  theme_minimal() +
  labs(x = "Sensitivity", y = "Specificity", fill = "Incremental benefit") +
  scale_fill_viridis_c()

ggplot(df, aes(x = sensitivity, y = specificity, fill = benefit_incremental)) + 
  geom_tile() +
  coord_fixed(ratio = 1) +
  theme_minimal() +
  labs(x = "Sensitivity", y = "Specificity", fill = "Incremental cost") +
  scale_fill_gradient2(low = munsell::mnsl("10R 6/10"), high = munsell::mnsl("10PB 6/10"), mid = "white")
```
