---
title: "Cost effectiveness analysis for an AMR point-of-care test"
author: "Adam Howes"
date: "`r Sys.Date()`"
output: 
  bookdown::html_document2:
    toc: true
    toc_float: true
    toc_collapsed: true
    toc_depth: 3
    number_sections: true
    theme: lumen
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(purrr)
library(dplyr)
library(tidyr)
library(ggplot2)
library(colorspace)
```

Consider a neonate with suspected neonatal sepsis in India.
We consider two scenarios:

* In the first scenario (Section \@ref(s1)) all neonates with suspected neonatal sepsis are treated using antibiotics.
* In the second scenario (Section \@ref(s2)) a point-of-care test (POCT) is used to identify neonatal sepsis.

These scenarios are compared using disability adjusted life year (DALY) and incremental cost-effectiveness ratio (ICER) metrics.

# Background

The number of children born in India each year is:

```{r}
births_per_year <- 25 * 10^6
```

Using a background rate of neonatal sepsis, the number of births with neonatal sepsis per year is:

```{r}
sepsis_rate <- 70 / 1000
(births_sepsis <- births_per_year * sepsis_rate)
```

Of these births, some proportion are assumed to be "high risk" with symptoms that are clear, while others are assumed to be "low risk" and do not have obvious symptoms.

```{r}
prop_high_risk_sepsis <- 0.4
prop_low_risk_sepsis <- 1 - prop_high_risk_sepsis
```

We assume all births with high risk sepsis are identified and treated with antibiotics:

```{r}
births_sepsis_high_risk <- births_sepsis * prop_high_risk_sepsis
(births_abx_sepsis_high_risk <- births_sepsis_high_risk)
```

Births with low risk sepsis may or may not be treated.
Assume some proportion of total neonates receive antibiotics, and that the remainder of those not prescribed to high risk sepsis neonates are perscribed to low risk sepsis neonates:

```{r}
births_sepsis_low_risk <- births_sepsis * prop_low_risk_sepsis
prop_abx <- 0.2
births_abx <- births_per_year * prop_abx
(births_abx_sepsis_low_risk <- births_abx - births_abx_sepsis_high_risk)
```

We quantify the additional AMR burden per perscrption of antibiotics as follows:

```{r}
total_births_per_year <- 130 * 10^6
total_births_abx_per_year <- total_births_per_year * prop_abx
total_sepsis_burden <- 24.6 * 10^6
prop_burden_abx <- 0.31
total_amr_burden <- total_sepsis_burden * prop_burden_abx
(amr_burden_per_abx <- total_amr_burden / total_births_abx_per_year)
```

Correct treatment of neonatal sepsis is associated to the following number of DALYs:

```{r}
benefit_correct_sepsis_diagnosis <- 9
```

# Treat all neonates {#s1}

First, consider treating all neonates with suspected sepsis:

```{r}
(benefit_s1 <- benefit_correct_sepsis_diagnosis * births_sepsis_low_risk - amr_burden_per_abx * (births_abx_sepsis_low_risk - births_sepsis_low_risk))
```

The total cost of this approach is:

```{r}
cost_culture <- 50
cost_treatment <- 5
(cost_s1 <- (cost_culture + cost_treatment) * births_abx_sepsis_low_risk)
```

The cost per DALY is then:

```{r}
(cost_per_daly_s1 <- cost_s1 / benefit_s1)
```

# Use a point of care test {#s2}

```{r}
total_cost_rdt <- 20
subsidy_rdt <- 10
(cost_rdt <- total_cost_rdt - subsidy_rdt)
```

The sensitivity is defined as

$$
\text{sensitivity} = \frac{\text{TP}}{\text{TP} + \text{FN}},
$$

and the specificity is defined as

$$
\text{specificity} = \frac{\text{TN}}{\text{TN} + \text{FP}}.
$$

For now we will take each to be fixed:

```{r}
sensitivity <- 0.9
specificity <- 0.9
```

```{r}
sepsis_prev_low_risk <- births_sepsis_low_risk / births_abx_sepsis_low_risk

#' Has sepsis and treated
(true_positive <- births_abx_sepsis_low_risk * sepsis_prev_low_risk * sensitivity)
  
#' Doesn't have sepsis and treated
(false_positive <- births_abx_sepsis_low_risk * (1 - sepsis_prev_low_risk) * (1 - specificity))
  
#' Has sepsis and not treated
(false_negative <- births_abx_sepsis_low_risk * sepsis_prev_low_risk * (1 - sensitivity))
  
#' Doesn't have sepsis and not treated
(true_negative <- births_abx_sepsis_low_risk * (1 - sepsis_prev_low_risk) * specificity)

stopifnot(true_positive + false_positive + false_negative + true_negative == births_abx_sepsis_low_risk)

#' Estimate that around half of false negatives would later be identified
harm_false_negative <- benefit_correct_sepsis_diagnosis * 0.5

(benefit_s2 <- true_positive * benefit_correct_sepsis_diagnosis + true_negative * amr_burden_per_abx - harm_false_negative * false_negative - amr_burden_per_abx * false_positive)
(cost_s2 <- (cost_culture + total_cost_rdt) * births_abx_sepsis_low_risk + (true_positive + false_positive) * cost_treatment)

#' Cost per DALY
(cost_per_daly_s2 <- cost_s2 / benefit_s2)
```

# Cost effectiveness

* Relevant outcomes
  1. Cost effectiveness of POCT (no subsidy)
  2. Cost effectiveness of POCT (subsidised)
    a) ICER compared to baseline scenario
    b) Cost effectiveness of prize for funders
* Vary `sensitivity` and `specificty` for 1. and 2.
* Vary `subsidy_rdt` for 2.

```{r}
#' Total amount of subsidy in scenario 2
(subsidy_test <- subsidy_rdt * births_abx_sepsis_low_risk)

#' Additional cost of scenario 2 over scenario 1 for government
(cost_incremental <- cost_s2 - subsidy_test - cost_s1)

#' Additional benefit of scenario 2 over scenario 1
(benefit_incremental <- benefit_s2 - benefit_s1)

#' ICER
(icer <- cost_incremental / benefit_incremental)
```

# Sensitivity analysis

To run the sensitivity analysis, we create a function `run_cea` implementing the cost effectiveness analysis above.
This function is stored in the file `functions.R`:

```{r}
source("../functions.R")
```

Check that `run_cea` produces the same outputs as above:

```{r}
run_cea(0.9, 0.9)
```

## Varying sensitivity and specificity

First, we consider varying the sensitivity and specificity of the POCT:

```{r}
grid <- seq(from = 0, to = 1, length.out = 41)
df <- tidyr::crossing(sensitivity = grid, specificity = grid)
df <- bind_cols(df, pmap_dfr(df, run_cea))
tail(df)
```

```{r}
ggplot(df, aes(x = sensitivity, y = specificity, fill = 1 / icer)) + 
  geom_tile() +
  coord_fixed(ratio = 1) +
  theme_minimal() +
  labs(x = "Sensitivity", y = "Specificity", fill = "DALYS per dollar") +
  scale_fill_continuous_diverging(palette = "Tropic")

ggplot(df, aes(x = sensitivity, y = specificity, fill = benefit_incremental)) + 
  geom_tile() +
  coord_fixed(ratio = 1) +
  theme_minimal() +
  labs(x = "Sensitivity", y = "Specificity", fill = "Incremental benefit") +
  scale_fill_continuous_diverging(palette = "Tropic", labels = scales::unit_format(unit = "M", scale = 10E-6))

ggplot(df, aes(x = sensitivity, y = specificity, fill = cost_incremental)) + 
  geom_tile() +
  coord_fixed(ratio = 1) +
  theme_minimal() +
  labs(x = "Sensitivity", y = "Specificity", fill = "Incremental cost") +
  scale_fill_viridis_c(labels = scales::unit_format(unit = "M", scale = 10E-6))

df %>%
  filter(sensitivity == 0.9) %>%
  ggplot(aes(x = specificity, y = 1 / icer)) +
  geom_line() +
  geom_hline(yintercept = 0, col = "lightgrey", linetype = "dashed") +
  theme_minimal() +
  labs(x = "Specificity", y = "DALYs per dollar", caption = "Sensitivity fixed to 90%")

df %>%
  filter(sensitivity == 0.9) %>%
  ggplot(aes(x = specificity, y = benefit_incremental)) +
  geom_line() +
  geom_hline(yintercept = 0, col = "lightgrey", linetype = "dashed") +
  theme_minimal() +
  scale_y_continuous(labels = scales::unit_format(unit = "M", scale = 10E-6)) +
  labs(x = "Specificity", y = "Incremental benefit (DALYs)", caption = "Sensitivity fixed to 90%")

df %>%
  filter(specificity == 0.9) %>%
  ggplot(aes(x = sensitivity, y = 1 / icer)) +
  geom_line() +
  geom_hline(yintercept = 0, col = "lightgrey", linetype = "dashed") +  
  theme_minimal() +
  labs(x = "Sensitivity", y = "DALYs per dollar", caption = "Specificity fixed to 90%")

df %>%
  filter(specificity == 0.9) %>%
  ggplot(aes(x = sensitivity, y = benefit_incremental)) +
  geom_line() +
  geom_hline(yintercept = 0, col = "lightgrey", linetype = "dashed") +
  theme_minimal() +
  scale_y_continuous(labels = scales::unit_format(unit = "M", scale = 10E-6)) +
  labs(x = "Sensitivity", y = "Incremental benefit (DALYs)", caption = "Specificity fixed to 90%")
```
